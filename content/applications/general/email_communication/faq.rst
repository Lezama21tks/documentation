=========
Email FAQ
=========

This document contains an explanation of the most recurring emailing issues in Odoo. First, outgoing
emails, and then, incoming emails.

Issues that will be covered regarding outgoing emails include the following: when an email isn't
sent, common error messages, such as: hitting the daily email limit, :abbr:`SMTP (Simple Mail
Transport Protocol)` errors, unsent emails with no errors, and when a message is sent late. For
incoming message issues that will be covered include: when emails are not received, and what to
include when contacting Odoo support.

Outgoing emails
===============

.. _red_envelop:

Email is not sent
-----------------

The first indicator showing that an email has not been sent is the presence of a :guilabel:`red
envelope`, next to the date and time of the message, located in the chatter.

.. image:: faq/red-envelop.png
   :align: center
   :alt: Red envelope displayed in chatter.

Unsent emails also appear in the Odoo email queue. In :ref:`developer mode <developer-mode>` this
can be accessed by going to :menuselection:`Settings app --> Technical Menu --> Emails --> Emails`.
Unsent emails appear in turquoise, while sent emails appear in grey.

Common error messages
~~~~~~~~~~~~~~~~~~~~~

.. _email_communication/daily_limit_mail:

Daily limit reached
*******************

.. image:: faq/email-limit.png
   :align: center
   :alt: Warning in Odoo upon email limit reached.

Each email service provider has its own email sending limits. The limits may be daily, hourly, and
sometimes, per minute. This is the same for Odoo, which limits a customer's sending to prevent
Odoo's email servers from being blacklisted.

Here are the default limits for new databases:

- 200 emails/day for Odoo Online and Odoo.sh databases with an active subscription.
- 50 emails/day for one-app free and trial databases.
- In case of migration, the database daily limit might be reset to 50 emails a day.

If the limit is reached, the following actions can be taken:

- Ask Odoo's support team to increase the daily limit. The support team analyzes the situation of
  the database depending on the following (non-exhaustive list):

  - How many users in the database.
  - Which apps are installed.
  - The bounce rate: the percentage of email addresses that did not receive emails because they were
    returned by a mail server on its way to the final recipient. Contact `support
    <https://www.odoo.com/help>`_.

- Use an external outgoing email server to be independent of Odoo's mail limit (refer to :doc:`the
  corresponding email documentation </applications/general/email_communication/email_servers>`).
- Wait until 11 PM (UTC) for the reset, and click on the retry button: The :ref:`developer mode
  <developer-mode>` must be activated. Then, go to :menuselection:`Settings app --> Technical -->
  Emails --> Emails`.

.. warning::
   The daily limit is global to the database, and can rise quickly. By default, an internal message,
   a notification, a note, etc. counts as an email in the daily limit if it notifies someone.

This can be mitigated by receiving :ref:`notifications in Odoo
<discuss_app/notification_preferences>`, instead of emails.

SMTP error
**********

It's easy to find out why an email wasn't transmitted successfully, by reviewing the Simple Mail
Transport Protocol (SMTP) error messages. :abbr:`SMTP (Simple Mail Transport Protocol)` is a
protocol to describe the email structure, and transmits it over the Internet. The error messages
generated by email services are helpful tools to diagnose and troubleshoot email problems.

.. note::
   The debug menu can be used to investigate sending issues from a database. To access the menu,
   :ref:`Developer mode <developer-mode>` must be activated. Once activated, navigate to the
   :menuselection:`Debug Menu` in the top right of the menu bar, :menuselection:`Debug Menu -->
   Manage Messages`

   The :guilabel:`Manage Messages` menu opens a list of all the messages sent in a particular
   record. Within each message there is information on sending, including what type, and subtype, of
   the message.

   Other information includes to whom the message was sent, and whether Odoo received a bounce-back
   from an email server.

No error
********

Odoo is not always capable of providing information for the reason it failed. The different email
providers implement a personalized policy of bounced emails, and it is not always possible for Odoo
to interpret it correctly.

If this is a recurring problem with the same client, or the same domain, do not hesitate to contact
`Odoo Support <https://www.odoo.com/help>`_ for help in finding a reason.

.. note::
   In such case, one of the most common reasons is related to :ref:`SPF
   <email_communication/spf_compliant>` and/or :ref:`DKIM <email_communication/DKIM_compliant>`
   configuration. Also, check to make sure the *mail.bounce.alias* is defined in the *system
   parameters*. Access system parameters in :ref:`developer mode <developer-mode>` by navigating to
   :menuselection:`Settings App --> Technical Menu --> Parameters --> System Parameters`.

Email sent late
***************

It may happen that an email campaign is scheduled, but isn't sent on time. It's known that Odoo uses
a delayed job to send emails that are considered as "not urgent" (newsletters concept, such as: mass
mailing, marketing automation, events). The system utility **cron** can be used to schedule programs
to run automatically at predetermined intervals. Odoo uses that policy in order to avoid cluttering
the mail servers and, instead, prioritizes the communication. This **cron** is called
:guilabel:`Mail: Email Queue Manager`, and can be accessed in :ref:`developer mode <developer-mode>`
by going to :menuselection:`Settings App --> Technical Menu --> Automation --> Scheduled Actions`.

By default, the *Mass Mailing cron* runs every 60 minutes. This can be changed to no less than 5
minutes. But, for the reasons mentioned above, this isn't recommended. Select the action
:guilabel:`Mail: Email Queue Manager,` and proceed to make any necessary adjustments.

.. image:: faq/email-scheduled-later.png
   :align: center
   :alt: Email scheduled to be sent later.

Emails that are considered urgent (communication from one person to another, such as: sales orders,
invoices, purchase orders, etc.) are sent directly (immediately).

Incoming emails
===============

When there is an issue with incoming emails, there might not be an indication, per se, in Odoo. It
is the sending email client, who tries to contact a database, that will get a bounce-back (most of
the time a :guilabel:`550: mailbox unavailable`).

Emails are not received
-----------------------

The following steps are all dependent on the Odoo platform the database is using:

- **Odoo.sh** users can find their live logs on the folder :file:`~/logs/`.

.. tip::
   The folder :file:`~/logs/` (preferably accessed by the command line) of an Odoo.sh database
   contains a list of files containing the logs of the database. The log files are created everyday
   at 5:00 AM (UTC).

   The two last days are not compressed, while the older ones are, in order to save space. The
   naming of the files for today and yesterday are respectively: :file:`odoo.log` and
   :file:`odoo.log.1`.

   For the following days, they are named with their dates, and then compressed. See the Odoo.sh
   documentation about :ref:`logs <odoosh/logs>`. Use the command :command:`grep` and
   :command:`zgrep` (for the compressed ones) to search through the files.

- **Odoo Online** users won't have access to the logs. However `Odoo Support
  <https://www.odoo.com/help>`_ can still be contacted, if there is a recurring issue with the same
  client or domain.

Get help from support
---------------------

In order to get helped efficiently, please provide as much information as possible. Here is a list
of what can be helpful when reaching out to support about an issue:

The **EML** (or **headers**) of the email is the file format containing all the technical
information required for an investigation. The documentation from the email provider might provide
the process on how to get EML/header files. Once the headers of the email are obtained, adding it
into the Odoo support ticket is the most efficient way for the Odoo Support team to investigate.

.. seealso::
   - `Gmail documentation
     <https://support.google.com/mail/answer/29436>`_
   - `Outlook documentation
     <https://support.microsoft.com/en-us/office/view-internet-message-headers-in-outlook-cd039382-dc6e-4264-ac74-c048563d212c#tab=Web>`_

The exact flow that is being followed in order to normally receive those emails in Odoo. Here are
examples of questions whose answers can be useful:

- Is this simply a reply from an email going out from Odoo?
- Is there an incoming email server being used, or is the email somehow being redirected?
- Is there an example of an email that has been correctly forwarded?

Providing answers to the following questions:

- Is it a generic issue, or is it specific to a use case? If specific to a use case, which one
  exactly?
- Is it working as expected? In case the email is sent using Odoo, the bounce email should reach the
  Odoo database, and display the :ref:`red envelope <red_envelop>`.

  .. seealso::
     The bounce system parameter needs to be set in the technical settings in order for the database
     to correctly receive bounce messages. To access this setting go to :menuselection:`Settings app
     --> Technical --> Parameters --> System Parameters`. The parameter name to select is
     :guilabel:`mail.bounce.alias`.
